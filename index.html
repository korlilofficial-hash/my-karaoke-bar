<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARAOKE SYSTEM PRO</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase 8 -->
    <script src="https://www.gstatic.com"></script>
    <script src="https://www.gstatic.com"></script>
    <style>
        :root { --blue: #0077ff; --dark: #0a0a0c; --card: #1a1a1d; --green: #28a745; --red: #dc3545; }
        body { background: var(--dark); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≠–ö–†–ê–ù–ê */
        .screen-container { max-width: 900px; margin: 0 auto; }
        .video-wrapper { background: #000; border: 2px solid #333; border-radius: 15px; overflow: hidden; height: 450px; margin-bottom: 20px; box-shadow: 0 0 30px rgba(0,119,255,0.2); }
        iframe { width: 100%; height: 100%; border: none; }
        .queue-list { background: var(--card); padding: 20px; border-radius: 12px; text-align: left; }
        .song-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; animation: fadeIn 0.3s; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ü–£–õ–¨–¢–ê */
        .guest-card { background: var(--card); padding: 25px; border-radius: 20px; max-width: 450px; margin: 0 auto; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 10px; border: 1px solid #444; background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-back { background: #444; color: #ccc; margin-top: 10px; }
        .step-desc { background: #222; padding: 10px; border-radius: 8px; font-size: 14px; border-left: 4px solid var(--blue); margin-bottom: 10px; line-height: 1.4; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° –≠–ö–†–ê–ù–ê (–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –æ–±—ã—á–Ω–æ–π —Å—Å—ã–ª–∫–µ) -->
    <div id="view-screen" class="hidden">
        <div class="screen-container">
            <h1 style="color:var(--blue)">üì∫ –≠–ö–†–ê–ù –ö–ê–†–ê–û–ö–ï</h1>
            <div class="video-wrapper">
                <iframe id="main-player" src="about:blank" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>
            </div>
            <div class="queue-list">
                <h3 style="margin-top:0">–û–ß–ï–†–ï–î–¨ –ó–ê–ö–ê–ó–û–í:</h3>
                <div id="queue-content">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—á–µ—Ä–µ–¥–∏...</div>
            </div>
        </div>
    </div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° –ü–£–õ–¨–¢–ê (–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Å—Å—ã–ª–∫–µ ?p=1) -->
    <div id="view-guest" class="hidden">
        <div class="guest-card">
            <h2>üé§ –ü–£–õ–¨–¢ –ì–û–°–¢–Ø</h2>
            
            <div id="step-1">
                <div class="step-desc">1. –ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É. –ü–æ–∏—Å–∫ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ.</div>
                <input type="text" id="search-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–∫—Ç–æ—Ä –ì–∞–∑–∞ –õ–∏—Ä–∏–∫–∞">
                <button class="btn-blue" onclick="runSearch()">üîç –ù–ê–ô–¢–ò –ü–ï–°–ù–Æ</button>
            </div>

            <div id="step-2" style="display:none">
                <div class="step-desc">2. –í—ã–±–µ—Ä–∏ –≤–∏–¥–µ–æ, —Å–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—Å—Ç–∞–≤—å –µ—ë —Å—é–¥–∞.</div>
                <input type="text" id="final-url" placeholder="–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É ://vk.com...">
                <button class="btn-green" onclick="submitToQueue()">‚úÖ –î–û–ë–ê–í–ò–¢–¨ –í –û–ß–ï–†–ï–î–¨</button>
                <button class="btn-back" onclick="resetSteps()">‚óÄ –ù–ê–ó–ê–î</button>
            </div>
        </div>
    </div>

<script>
    // –¢–í–û–ô –ö–û–ù–§–ò–ì FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyBorratezI1ExpJ3j7euvgNuJHGBzvEMqk",
        authDomain: "my-caraoke-bar.firebaseapp.com",
        databaseURL: "https://my-caraoke-bar-default-rtdb.firebaseio.com",
        projectId: "my-caraoke-bar",
        storageBucket: "my-caraoke-bar.firebasestorage.app",
        messagingSenderId: "962264196959",
        appId: "1:962264196959:web:d3db4e060adf0e746f38ea"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ (–≠–∫—Ä–∞–Ω –∏–ª–∏ –ü—É–ª—å—Ç)
    const params = new URLSearchParams(window.location.search);
    const mode = params.has('p') ? 'guest' : 'screen';

    if (mode === 'guest') {
        document.getElementById('view-guest').classList.remove('hidden');
    } else {
        document.getElementById('view-screen').classList.remove('hidden');
        startScreenListener();
    }

    // --- –õ–û–ì–ò–ö–ê –ü–£–õ–¨–¢–ê (–ì–û–°–¢–¨) ---
    function runSearch() {
        const q = document.getElementById('search-input').value;
        if (!q) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏!");
        window.open(`https://://vk.com?q=${encodeURIComponent(q + ' –∫–∞—Ä–∞–æ–∫–µ')}`, '_blank');
        document.getElementById('step-1').style.display = 'none';
        document.getElementById('step-2').style.display = 'block';
    }

    function resetSteps() {
        document.getElementById('step-1').style.display = 'block';
        document.getElementById('step-2').style.display = 'none';
    }

    function submitToQueue() {
        const url = document.getElementById('final-url').value.trim();
        const match = url.match(/video(-?\d+)_(\d+)/);
        
        if (match) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º —á–∏—Å—Ç—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –ø–ª–µ–µ—Ä–∞
            const cleanUrl = `https://://vk.com_ext.php?oid=${match[1]}&id=${match[2]}&hash=0&hd=2`;
            db.ref('karaoke_live').push({
                url: cleanUrl,
                ts: Date.now()
            }).then(() => {
                alert("–ü–µ—Å–Ω—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
                document.getElementById('final-url').value = '';
                resetSteps();
            });
        } else {
            alert("–û—à–∏–±–∫–∞! –í—Å—Ç–∞–≤—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ –í–ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, ://vk.com-123_456)");
        }
    }

    // --- –õ–û–ì–ò–ö–ê –≠–ö–†–ê–ù–ê (–ê–î–ú–ò–ù) ---
    function startScreenListener() {
        db.ref('karaoke_live').on('value', (snap) => {
            const container = document.getElementById('queue-content');
            container.innerHTML = '';
            const data = snap.val();
            
            if (data) {
                Object.keys(data).forEach((id, index) => {
                    const item = data[id];
                    container.innerHTML += `
                        <div class="song-item">
                            <span><b>#${index + 1}</b> –ü–µ—Å–Ω—è –≤ –æ—á–µ—Ä–µ–¥–∏</span>
                            <div>
                                <button onclick="playSong('${item.url}')" style="width:50px; background:var(--green); color:white; border-radius:5px; border:none; padding:8px; cursor:pointer">‚ñ∂</button>
                                <button onclick="removeSong('${id}')" style="width:50px; background:var(--red); color:white; border-radius:5px; border:none; padding:8px; cursor:pointer; margin-left:5px">‚ùå</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<p style="color:#666">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞. –ñ–¥–µ–º –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ QR...</p>';
            }
        });
    }

    function playSong(url) {
        document.getElementById('main-player').src = url;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function removeSong(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–µ—Å–Ω—é?")) {
            db.ref('karaoke_live/' + id).remove();
        }
    }
</script>
</body>
</html>
